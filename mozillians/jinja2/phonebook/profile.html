{% extends "base.html" %}
{% block page_title %}
  {{ profile.display_name|default(shown_user.username, true) }}
{% endblock %}
{% block body_id %}profile{% endblock %}
{% block body_class %}
  {{ super() }}
  {% if not profile.is_vouched %}pending{% endif %}
{% endblock %}

{% block content %}
  <div class="alert">
    {% if user.username == shown_user.username %}
      {{ _('Your Profile') }}
    {% elif profile.is_vouched %}
      {{ _('Mozillian Profile') }}
    {% endif %}
  </div>
  {% if user.is_authenticated() and not profile.is_vouched %}
    {% if user == shown_user %}
      <div id="pending-approval">
        {% trans vouching_url='https://wiki.mozilla.org/Mozillians/Vouching',
                 profile_url=absolutify(url('phonebook:profile_view', user.username)),
                 contribute_url='https://www.mozilla.org/contribute' %}
          <p>
            Your profile is waiting to be vouched. Once you are vouched,
            you will be able to view the profiles of all Mozillians,
            join groups and access additional content on other sites as
            a Mozillian. <a href="{{ vouching_url }}">Learn more about
            vouching</a>.
          </p>
          <p>
            Send the link below to someone who is familiar with your
            contributions and ask them to vouch for you:
            <br/>
            <em class="underline" title="Your profile URL">{{ profile_url }}</em>
          </p>
          <p>
            If you are new to the Mozilla community,
            <a class="button" href="{{ contribute_url }}">get involved</a>
          </p>
          <p>The chances of being vouched increase as you finish tasks in our community.</p>
        {% endtrans %}
      </div>
    {% elif profile.is_vouchable(user.userprofile) %}
      <div id="pending-approval">
        <p>
          {% trans %}
            This profile is waiting for approval. If you would like to
            vouch for them, use the form at the bottom of the page.
          {% endtrans %}
        </p>
      </div>
    {% endif %}
  {% endif %}

  {% if privacy_mode == 'anonymous' and not profile.is_public %}
    <div id="anonymous">
      {% trans edit_url=url('phonebook:profile_edit') %}
        Your profile is not public. If you <a href="{{ edit_url }}">edit
        your profile</a> to have at least one public field,
        your public profile will be viewable.
      {% endtrans %}
    </div>
  {% endif %}
  <div class="vcard h-card">

    <article id="profile-info">
      <header>
        {% if user == shown_user %}
          <div class="privacy-view">
            <form method="GET" action=".">
              <label>{{ _('View as:') }}</label>
              <select id="view-privacy-mode">
                  <option value="{{ url('phonebook:profile_view', shown_user.username) }}"
                          {% if privacy_mode == 'myself' %} selected {% endif %}>
                    {{ _('Myself') }}
                  </option>
                  <option value="{{ url('phonebook:profile_view', shown_user.username)|urlparams(view_as='mozillian') }}"
                          {% if privacy_mode == 'mozillian' %} selected {% endif %} >
                    {{ _('Mozillian') }}
                  </option>
                  <option value="{{ url('phonebook:profile_view', shown_user.username)|urlparams(view_as='anonymous') }}"
                          {% if privacy_mode == 'anonymous' %} selected {% endif %}>
                    {{ _('Public') }}
                  </option>
              </select>
            </form>
          </div>
        {% endif %}
        <h1 class="p-name">
          <span class="fn">{{ profile.display_name|default(shown_user.username, true) }}</span>
        </h1>
        {% if profile.full_name_local %}
          <h2>
            <span class="fn">{{ profile.full_name_local }}</span>
          </h2>
        {% endif %}
        {% if profile.title %}
          <h2><span class="title">{{ profile.title }}</span></h2>
        {% endif %}
      </header>


      <section id="profile-details">
        <div class="stats">
          {% set mozillian_years = get_mozillian_years(profile) %}
          {% if not mozillian_years is none %}
            <section id="membership">
                <div class="status">
                  <i class="icon-calendar"></i>
                  {% if mozillian_years > 1 %}
                      Mozillian for {{ mozillian_years }} years -
                  {% else %}
                      Mozillian for less than a year -
                  {% endif %}
                  <span>{{ profile.date_mozillian.strftime('%b %Y') }}</span>
                </div>
            </section>
          {% endif %}
        </div>

        {% if profile.vouches_received.exists() %}
          <div id="vouched_by" class="profile-entry">
            <h3>{{ _('Vouched By') }}</h3>
            <ul>
              {% for vouch in profile.vouches_received.all() %}
                <li>
                  {% if vouch.voucher %}
                    <a href="{{ url('phonebook:profile_view', vouch.voucher.user.username) }}">
                      {{ vouch.voucher.display_name|default(vouch.voucher.user.username, true)}}
                    </a>
                  {% elif vouch.autovouch %}
                    <a href="{{ url('phonebook:about-dinomcvouch') }}">
                      Dino McVouch
                    </a>
                  {% else %}
                    {{ _('Unknown Voucher') }}
                  {% endif %}
                  {% if not vouch.description %}
                    <p>{{ _('Legacy vouch.') }}</p>
                  {% else %}
                    {{ vouch.description|markdown }}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        {% if profile.vouches_made.exists() %}
          <div id="vouchees" class="profile-entry">
            <h3>{{ _('Vouchees') }}</h3>
            <ul>
              {% for vouch in profile.vouches_made.all().order_by('vouchee__full_name') %}
                <li>
                  <a href="{{ url('phonebook:profile_view', vouch.vouchee.user.username) }}">
                    {{ vouch.vouchee.display_name|default(vouch.vouchee.user.username, true)}}
                  </a>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
          <form action="{{ url('phonebook:profile_view', shown_user.username) }}" method="POST"
                id="vouch-form">
            {% include 'phonebook/includes/profile_vouch.html' %}
          </form>
      </section>

    </article>

    {# H-card support, add group Mozillians #}
    <span class="hidden category">Mozillians</span>

  </div>
{% endblock %}

{% block page_js %}
  {% compress js %}
    <script src="{{ static('mozillians/js/profile_view.js') }}"></script>
    <script src="{{ static('mozillians/js/character_limit.js') }}"></script>
  {% endcompress %}
{% endblock %}
